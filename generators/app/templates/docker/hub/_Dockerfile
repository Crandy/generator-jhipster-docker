FROM jdubois/jhipster-docker
MAINTAINER Pascal Grimaud <pascalgrimaud@gmail.com>

# parameters
ENV JHIPSTER_GITHUB <%= dockerRepoGithub %>

# clone project
USER jhipster
RUN cd /home/jhipster && \
    git clone ${JHIPSTER_GITHUB} /home/jhipster/github/ && \
    cd /home/jhipster/github/ && \
    <%_ if (buildTool == 'maven') { _%>
    mvn -Pprod package -DskipTests=true && \
    mv /home/jhipster/github/target/*.war /home/jhipster/app.war && \
    <%_ } else if (buildTool == 'gradle') { _%>
    ./gradlew -Pprod build -x test && \
    mv /home/jhipster/github/build/libs/*.war /home/jhipster/app.war && \
    <%_ } _%>
    rm -Rf /home/jhipster/github && \
    rm -Rf /home/jhipster/.m2/repository/ && \
    rm -Rf /home/jhipster/.npm/

USER root
RUN mv /home/jhipster/app.war /app.war

RUN bash -c 'touch /app.war'
ADD run.sh /run.sh
RUN chmod +x /run.sh

EXPOSE 8080
# read -> https://spring.io/guides/gs/spring-boot-docker/
VOLUME /tmp
CMD ["/run.sh"]
